# Imgdiff — сравнение изображений (GUI)

**Русская версия** | **[English](README_EN.md)**

Простое и быстрое сравнение изображений с наглядной подсветкой отличий.

- Windows GUI (PyQt5), OpenCV 4.x
- Параллельная пакетная обработка
- Overlay (заливка) с настройкой цветов A/B/совпадений
- Быстрое сохранение (auto PNG compression), кэш результатов

## Установка и запуск

```bash
# Зависимости (если нужны)
pip install -r requirements.txt

# Запуск GUI
python Imgdiff.py
```

Или скачайте готовый Windows EXE из [Releases](https://github.com/mikhalchankasm/Imgdiff/releases).

## Базовые шаги

1) Выберите папки A и B, затем папку вывода.
2) Включите Overlay (галочка над просмотрщиком) и подберите цвета:
   - Цвет A (удалено): по умолчанию красный (#FF0000)
   - Цвет B (добавлено): по умолчанию синий (#0066FF)
   - Цвет совпадений: по умолчанию синий (#0000FF)
3) Нажмите «Сравнить» — отличающиеся пары сохраняются в папку вывода.

Подсказки:
- Вертикальная «неоновая» линия разделителя заметна на больших изображениях.
- В режиме Overlay поверх базового изображения B накладывается полупрозрачная заливка отличий.

## Продвинутые настройки (скрыты по умолчанию)

Оптимальные значения установлены по умолчанию; при необходимости раскройте блок «Показать продвинутые настройки»:
- fuzz (чувствительность): 3–10
- толщина (px): 3
- подавление шума: включено
- min area: 20
- gamma: 1.0
- допуск совпадений: 0 (выкл.)
- fast ROI core: включено
- save only diffs: включено
- PNG compression: авто (или 1 вручную)
- Quick pre-check: ~0.10%
- Quick max side: 256
- Workers: ~кол-во ядер (по умолчанию 4–8)

Кнопка «Сбросить настройки» возвращает значения по умолчанию.

## Использование Python API

Imgdiff можно использовать как Python библиотеку:

```python
from imgdiff import diff_mask_fast, draw_diff_overlay, coarse_to_fine
import cv2

# Загрузка изображений
img_a = cv2.imread('image_a.png')
img_b = cv2.imread('image_b.png')

# Быстрая маска отличий
mask = diff_mask_fast(img_a, img_b, fuzz=10, use_lab=True)

# Создание overlay визуализации
overlay = draw_diff_overlay(
    img_b,  # базовое изображение
    mask,
    color=(0, 102, 255),  # формат BGR
    alpha=0.4,
    gamma=1.0
)

# Сохранение результата
cv2.imwrite('result_overlay.png', overlay)

# Для ускорения на больших изображениях используйте coarse-to-fine:
bboxes = coarse_to_fine(img_a, img_b, fuzz=10, min_area=50)
print(f"Найдено {len(bboxes)} областей отличий")
```

Все доступные функции см. в [imgdiff/\_\_init\_\_.py](imgdiff/__init__.py).

## Сборка/локальная разработка

Все .bat и вспомогательные скрипты перенесены в `local-dev/` и исключены из релиза. Они предназначены только для локальной сборки/публикации.

## Иконка

Иконка программы: `imgdiff_icon.ico` (есть в репозитории). Для пересоздания есть скрипт `create_icon.py`.

## Версии

- 2.1.0: упрощённый Overlay, базовые/продвинутые настройки, авто PNG, кэш, неоновая линия разделителя.
- 2.0.0: исходная стабильная версия.
\n## Быстрая памятка (UI)

- Папки A/B: выберите папки с изображениями; пары сопоставляются по именам (естественная сортировка).
- Фильтр: подстрока без масок. Примеры: `mask`, `.png`, `_v2`, `report_2024`.
- Цвета: HEX или имя. Примеры: `#FF0000`, `red`, `#0066FF`.
- Папка вывода: куда сохраняются `diff`, `overlay`, `mask` (например: `D:\results`).
- Кнопки: `⚡ Сравнить` — запуск пакета; `Pause` — пауза/продолжить; `Stop` — остановить после текущей пары.

## Возможности

### Режимы сравнения
- **Overlay** — Полупрозрачные цветные области на изображении
- **Contours** — Контуры границ отличий
- **Heatmap** — Тепловая карта интенсивности различий

### Обработка
- **Пакетная обработка** — Множество пар изображений параллельно
- **Кэширование** — Избежание повторных вычислений для идентичных пар
- **Мультимасштаб** — Coarse-to-fine для ускорения в 5-20 раз
- **Выравнивание** — Автоматическое выравнивание изображений (ECC)
- **Фильтрация шума** — Медианное размытие + морфологические операции

### Оптимизации производительности
- Векторизованные операции (без Python циклов)
- Ранний выход при отсутствии отличий
- Морфология только на масках, а не на полных изображениях
- Адаптивное масштабирование ROI (0.15-0.33 в зависимости от разрешения)
- Быстрая предварительная проверка для пропуска идентичных изображений

## Бенчмарки

| Разрешение | v1.x | v2.0+ | Ускорение |
|------------|------|-------|-----------|
| 1920×1080 | 120мс | 15мс | **8×** |
| 3840×2160 | 480мс | 40мс | **12×** |
| 7680×4320 | 1900мс | 110мс | **17×** |

## Лицензия

MIT License. Подробности в файле [LICENSE](LICENSE).

## Участие в разработке

Вклады приветствуются! См. [CONTRIBUTING.md](CONTRIBUTING.md) для рекомендаций.

## Проблемы

Сообщайте об ошибках и запросах функций на [GitHub Issues](https://github.com/mikhalchankasm/Imgdiff/issues).
